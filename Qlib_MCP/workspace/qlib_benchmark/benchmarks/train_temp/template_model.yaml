sys:
  path:
    - Qlib_MCP/workspace
qlib_init:
  provider_uri: ~/.qlib/qlib_data/cn_data
  region: cn
market: &market csi300
benchmark: &benchmark SH000300
data_handler_config: &id001
  start_time: '2010-01-01'
  end_time: '2025-06-30'
  fit_start_time: '2010-01-01'
  fit_end_time: '2020-12-31'
  instruments: *market
  # 添加数据处理器配置
  infer_processors:
    - class: RobustZScoreNorm
      kwargs:
        fields_group: feature
        clip_outlier: true
    - class: Fillna
      kwargs:
        fields_group: feature
  learn_processors:
    - class: DropnaLabel
    - class: CSRankNorm
      kwargs:
        fields_group: label
  # 显式定义 label
  label: ["Ref($close, -2) / Ref($close, -1) - 1"]

port_analysis_config: &id002
  strategy:
    class: TopkDropoutStrategy
    module_path: qlib.contrib.strategy
    kwargs:
      signal: <PRED>
      topk: 50
      n_drop: 10
  backtest:
    start_time: '2025-01-01'
    end_time: '2025-06-30'
    account: 100000000
    benchmark: *benchmark
    exchange_kwargs:
      limit_threshold: 0.095
      deal_price: close
      open_cost: 0.0005
      close_cost: 0.0015
      min_cost: 5

task:
  model:
    class: TransformerModel
    module_path: qlib_benchmark.benchmarks.model.pytorch_transformer_ts
    kwargs:
      seed: 0
      n_jobs: 20
      d_feat: 24  # ✅ 正确：19 个因子
  dataset:
    class: TSDatasetH
    module_path: qlib.data.dataset
    kwargs:
      handler:
        class: CustomFactors_20260114_152914
        module_path: qlib_benchmark.factor_pools.custom_factors_20260114_152914
        kwargs: *id001
      segments:
        train:
        - '2010-01-01'
        - '2020-12-31'
        valid:
        - '2021-01-01'
        - '2024-12-31'
        test:
        - '2024-12-31'
        - '2025-06-30'
      step_len: 20  # ⚠️ 建议改为 20（从 30 改小）
  record:
  - class: SignalRecord
    module_path: qlib.workflow.record_temp
    kwargs:
      model: <MODEL>
      dataset: <DATASET>
  - class: SigAnaRecord
    module_path: qlib.workflow.record_temp
    kwargs:
      ana_long_short: false
      ann_scaler: 252
  - class: PortAnaRecord
    module_path: qlib.workflow.record_temp
    kwargs:
      config: *id002
